{% extends 'workshops/edit_author.html' %}
{% load static %}
{% block content %}
{% load crispy_forms_tags %} 
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper Submitted Correctly</title>
  <link rel="stylesheet" href="{% static 'ceur_ws_workshops/workshops/static/workshops/styles.css' %}">
  <style>
.delete_object {
  color: red;
  border-color: #f5c6cb;
  position: relative;
  padding: .75rem 1.25rem;
  border: 1px solid transparent;
  font-weight: bold;
  text-align: left;
  display: flex;
  align-items: center;
}

.delete_object input[type="checkbox"] {
  margin-right: 0.5rem;
}

.delete_object label {
  margin: 0;
}

.author-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.toggle-details {
  cursor: pointer;
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
}

.down {
  transform: rotate(45deg);
  -webkit-transform: rotate(45deg);
}

.up {
  transform: rotate(-135deg);
  -webkit-transform: rotate(-135deg);
}

.handle {
  display: inline-block;
  border-top: 3px solid var(--dark);
  width: 30px;
  padding-top: 5px;
  cursor: grab;
}

.handle:after, .handle:before {
  display: block;
  content: "";
  padding-top: 5px;
  border-top: 3px solid var(--dark);
}

.handle:hover, .handle:hover:before, .handle:hover:after {
  border-color: var(--primary);
}

.handle:active, .handle:active:before, .handle:active:after {
  cursor: grabbing;
}

.author-container {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  list-style: none;
}

.author-container {
  display: flex;
  align-items: center;
  width: 100%;
  background: #f9f9f9;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
}

.author-name {
  font-size: 1.2em;
  font-weight: bold;
  margin-right: 10px;
}

.author-details {
  display: none;
  padding: 10px 0 0 30px;
}

.author-item {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  list-style: none; 
}
.delete_object {
  margin-top: 10px;
}

.blue-background-class {
  background-color: #e0f7fa;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
}

.down {
  transform: rotate(45deg);
  -webkit-transform: rotate(45deg);
}

.up {
  transform: rotate(-135deg);
  -webkit-transform: rotate(-135deg);
}

  </style>
</head>

<body>
  {% if edit_mode %}
  <h1>Edit Paper Details</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <fieldset>
      <legend>Paper Details</legend> 
      {{ paper_form|crispy }}
      <p>Uploaded File: <a href="{{ paper_form.instance.uploaded_file.url }}">{{ paper_form.instance.uploaded_file.name }}</a></p>
      <p>Agreement File: <a href="{{ paper_form.instance.agreement_file.url }}">{{ paper_form.instance.agreement_file.name }}</a></p>
    </fieldset>
    
   <fieldset id="author-fieldset">
    <legend>Author Details</legend>
    <div id="author-form" class="author-form">
        {{ author_formset.management_form }}
        {% for form in author_formset %}
        <li class = "author-item">
        <div class="author-container">
            <div class="author-summary">
                <span class="author-name">{{ form.author_name.value }}</span>
                <i class="arrow down toggle-details"></i>
            </div>
            <div class="author-details" style="display: none;">
                {{ form|crispy }}
                <div class="delete_object">
                    <input type="checkbox" name="authors_to_delete" value="{{ form.instance.id }}">
                    <label for="authors_to_delete">Select to delete an author from the paper.</label>
                </div>
            </div>
            <hr>
        </div>
      </li>
        {% endfor %}
    </div>
    <input type="button" value="Add Author" class="button-13" id="add_author">
</fieldset>
  
  
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          function setupToggleIcons() {
              const toggleIcons = document.querySelectorAll('.toggle-details');
  
              toggleIcons.forEach(icon => {
                  icon.addEventListener('click', function() {
                      const detailsDiv = this.parentElement.nextElementSibling;
                      if (detailsDiv.style.display === 'none') {
                          detailsDiv.style.display = 'block';
                          this.classList.remove('down');
                          this.classList.add('up');
                      } else {
                          detailsDiv.style.display = 'none';
                          this.classList.remove('up');
                          this.classList.add('down');
                      }
                  });
              });
          }
  
          setupToggleIcons();
  
          document.getElementById('add_author').addEventListener('click', function() {
              const formContainer = document.getElementById('author-form');
              const totalFormsInput = document.getElementById('id_author-TOTAL_FORMS');
              let formCount = parseInt(totalFormsInput.value, 10);
  
              const newFormHtml = `
                  <div class="author-container">
                      <div class="author-summary">
                          
                      </div>
                      <div class="author-details" style="display: none;">
                          ${formContainer.children[1].innerHTML.replace(/author-\d+/g, `author-${formCount}`)}
                          
                      </div>
                  </div>
              `;
              formContainer.insertAdjacentHTML('beforeend', newFormHtml);
              setupToggleIcons();
  
              formCount++;
              totalFormsInput.value = formCount;
          });
      });
  </script>
    <input type="submit" name="submit_button" class="button-13" value="Confirm">
  </form>

  <div id="empty_author_form" style="display:none">
    <table class='no_error'>
      {{ author_formset.empty_form|crispy}}
      <br>
    </table>
    <hr>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let messages = Array.from(document.querySelectorAll('#django-messages [data-message]')).map(el => el.getAttribute('data-message'));
    });
  
    $('#add_author').click(function () {
      var form_idx = $('#id_author-TOTAL_FORMS').val();
      $('#author-form').append($('#empty_author_form').html().replace(/__prefix__/g, form_idx));
      $('#id_author-TOTAL_FORMS').val(parseInt(form_idx) + 1);
    });
  </script>
  
  {% else %}
  <h1>Paper Submitted Correctly</h1>
  <p style = "text-align: center;">Your author and metadata have been successfully uploaded to <strong>{{ workshop.workshop_full_title }}</strong>.</p>
  <fieldset>
    <legend>Paper Details</legend>
    <p><strong>Paper Title:</strong> {{ paper.paper_title }}</p>
    <p><strong>Pages:</strong> {{ paper.pages }}</p>
    <p><strong>Uploaded File:</strong> <a href="{{ paper.uploaded_file.url }}" target="_blank">{{ paper.uploaded_file.name }}</a></p>

    <p><strong>Uploaded Agreement:</strong> <a href="{{ paper.agreement_file.url }}" target="_blank">{{ paper.agreement_file.name }}</a></p>
   
    {%if not paper.session%}
    <i>The paper has not yet been assigned to a session.</i>
    {%else%}
    <p><strong>Session:</strong> {{ paper.session }}</p>
    {%endif%}
  </fieldset>
  <br>
  <fieldset>
    <legend>Author Details:</legend>
    <ul>
      {% for author in paper.authors.all %}
      <li><strong>Name:</strong> {{ author.author_name }}</li>
      <li><strong>University:</strong> {{ author.author_university }}</li>
      <li><strong>University URL:</strong> <a href="{{ author.author_uni_url }}">{{ author.author_uni_url }}</a></li>
      <li><strong>Email:</strong> {{ author.author_email }}</li>
      <hr>
      {% endfor %}
    </ul>
  </fieldset>

  <p style = "text-align:center"><i>If you wish to make further changes at a later stage to the paper or author details please save this url:</i></p>
  <br>

  <fieldset>
  <div class="submit-container">
  <div class="tooltip">

  <a id="author_url" href="{{ request.build_absolute_uri }}" target="_blank">Author edit URL</a>
    <button class="copy_clipboard" onclick="CopyText('author_url', 'tooltip_edit_author')" onmouseout="outFunc('tooltip_edit_author')">
      <span class="tooltiptext" id="tooltip_edit_author">Copy to clipboard</span>
      <img src="{% static 'workshops/icons8-copy-24.png' %}" alt="Copy to clipboard" width="20" height="20">
    </button>
  </div>

  <form method="post"  enctype="multipart/form-data">
    {% csrf_token %}
    <br>
    <br>
    <br>
    <input  type="submit" name="edit_button" class="button-13" value="Edit" style="display: center;">
  </div>
  </form>

</fieldset>
  {% endif %}

</body>
</html>
{% endblock %}
